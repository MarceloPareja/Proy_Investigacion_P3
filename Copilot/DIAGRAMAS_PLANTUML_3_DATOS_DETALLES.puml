'=== DIAGRAMA 17: MODELO ENTIDAD-RELACIÓN (ER DIAGRAM) ===
@startuml ERDiagram_Database
title Modelo Entidad-Relación: Base de Datos

entity "USERS" as USERS {
    * id: INT
    --
    * email: VARCHAR(255) [UNIQUE]
    * nombre: VARCHAR(100)
    * apellido: VARCHAR(100)
    * password_hash: VARCHAR(255)
    * rol: ENUM(ADMIN, AUTHOR, REVIEWER)
    * afiliacion: VARCHAR(255)
    * especialidad: VARCHAR(255)
    * activo: BOOLEAN
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

entity "PAPERS" as PAPERS {
    * id: INT
    --
    * titulo: VARCHAR(500)
    * resumen: TEXT
    * autor_id: INT [FK]
    * coautores: JSON
    * archivo_ruta: VARCHAR(500)
    * version: INT
    * estado: ENUM
    * palabras_clave: JSON
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

entity "REVIEWS" as REVIEWS {
    * id: INT
    --
    * paper_id: INT [FK]
    * revisor_id: INT [FK]
    * puntuacion: DECIMAL(3,1)
    * resumen_ejecutivo: TEXT
    * fortalezas: TEXT
    * debilidades: TEXT
    * comentarios: TEXT
    * recomendacion: ENUM
    * cambios_sugeridos: JSON
    * estado: ENUM
    created_at: TIMESTAMP
    updated_at: TIMESTAMP
}

entity "DECISIONS" as DECISIONS {
    * id: INT
    --
    * paper_id: INT [FK, UNIQUE]
    * decision: ENUM
    * comentarios_comite: TEXT
    * cambios_requeridos: JSON
    * puntuacion_promedio: DECIMAL
    * aceptaciones: INT
    * rechazos: INT
    created_at: TIMESTAMP
}

entity "NOTIFICATIONS" as NOTIFICATIONS {
    * id: INT
    --
    * usuario_id: INT [FK]
    * tipo: ENUM
    * titulo: VARCHAR(255)
    * mensaje: TEXT
    * leida: BOOLEAN
    * enlace: VARCHAR(500)
    created_at: TIMESTAMP
}

entity "AUDIT_LOG" as AUDIT {
    * id: INT
    --
    * usuario_id: INT [FK]
    * accion: VARCHAR(255)
    * entidad_tipo: VARCHAR(100)
    * entidad_id: INT
    * cambios_anteriores: JSON
    * cambios_nuevos: JSON
    * ip_address: VARCHAR(50)
    created_at: TIMESTAMP
}

USERS ||--o{ PAPERS: escribe
USERS ||--o{ REVIEWS: realiza
USERS ||--o{ NOTIFICATIONS: recibe
USERS ||--o{ AUDIT: ejecuta

PAPERS ||--o{ REVIEWS: tiene
PAPERS ||--|| DECISIONS: genera
REVIEWS ||--o{ DECISIONS: informa

@enduml


'=== DIAGRAMA 18: FLUJO DE COLAS (MESSAGE QUEUE) ===
@startuml Activity_MessageQueue
title Flujo: Sistema de Colas y Tareas Asincrónicas

start

:Evento de negocio
(ej: Paper enviado);

:Backend service
genera evento;

:Evento entra en
RabbitMQ Queue;

:Workers Celery
escuchan queue;

fork

:Worker 1:
Email Sender;
    :Conecta a SendGrid;
    :Envía email;
    :Reintentos si falla;

fork again

:Worker 2:
PDF Generator;
    :Genera resumen PDF;
    :Guarda en S3;

fork again

:Worker 3:
Analytics;
    :Registra evento;
    :Envía a analytics;

fork again

:Worker 4:
Indexer;
    :Indexa paper
    en Elasticsearch;

end fork

:Todos completan;

:Marcar evento
como procesado;

:Log en auditoría;

stop

@enduml


'=== DIAGRAMA 19: CICLO DE VIDA DE REVISOR ===
@startuml Sequence_ReviewerWorkflow
title Secuencia: Flujo de Revisor de Inicio a Fin

actor Revisor
participant Website
participant API
participant EmailService
participant DB

Revisor -> Website: Accede a\nportal de revisores
activate Website

Website -> API: GET /reviews\n(papersAsignados)
activate API
API -> DB: SELECT * FROM reviews\nWHERE revisor_id = ?\nAND status = 'PENDING'

activate DB
DB --> API: 3 papers a revisar
deactivate DB

API --> Website: JSON con papers
deactivate API

Website --> Revisor: Muestra lista de papers\ncon deadlines
deactivate Website

loop Para cada paper (máx 3)
    Revisor -> Revisor: Lee el paper\n(puede ser 1-2 horas)
    
    Revisor -> Website: Completa formulario\nde evaluación
    activate Website
    
    Website -> API: POST /reviews/{id}\n(formulario)
    activate API
    
    API -> API: Valida datos\nde evaluación
    
    API -> DB: UPDATE reviews\nSET status = 'SUBMITTED'
    activate DB
    deactivate DB
    
    API -> EmailService: Queue: notifyReviewSubmitted\n(admin email)
    activate EmailService
    EmailService --> API: ✓ Queued
    deactivate EmailService
    
    API -> API: Generate event\nReviewSubmitted
    
    API --> Website: 200 OK\n{message: "Review enviada"}
    deactivate API
    
    Website --> Revisor: "✓ Evaluación enviada"
    deactivate Website
end

note right of Revisor
Todos los reviews completados
o deadline llegó
end note

Revisor -> Website: Accede portal
Website -> API: GET /reviews\n(filtro: revisor_id)
API --> Website: Todas las reviews enviadas
Website --> Revisor: "Todas tus evaluaciones\nhan sido enviadas"

@enduml


'=== DIAGRAMA 20: CICLO DE COMPILACIÓN Y DECISIÓN ===
@startuml Activity_CompilationDecision
title Actividades: Compilación de Reviews y Toma de Decisión

start

:Admin selecciona fecha
de cierre de reviews;

:Sistema cierra recepción
de nuevas reviews;

:Admin inicia compilación;

:Para cada paper:;
note right: Procesar todos en paralelo

:Obtener 3 reviews;

if (¿Tiene 3 reviews?) then (No)
    :Notificar Admin:
    Paper incompleto;
else (Sí)
endif

:Calcular puntuación promedio
(escala 0-10);

:Contar recomendaciones;
note right
Accept count
Reject count
Review count
end note

:Identificar cambios sugeridos
(merge de las 3 reviews);

:Compilar informe;

:Guardar estadísticas;

:Pasar a Comité;

:Comité revisa compilación;

:Comité vota decisión;
note right
1 click = Accept
2 clicks = Changes Required
3 clicks = Reject
end note

:Guardar decisión final;

:Generar histórico;

:Queue notificaciones
a autores;

stop

@enduml


'=== DIAGRAMA 21: VISTA MODULAR (MÓDULOS DEL SISTEMA) ===
@startuml ModuleView
title Vista de Módulos: Arquitectura Modular

package "core" {
    component BaseEntity [BaseEntity]
    component QueryBuilder [QueryBuilder]
    component Validator [Validator]
}

package "auth" {
    component AuthService [AuthService]
    component JWTHandler [JWTHandler]
    component PermissionChecker [PermissionChecker]
}

package "papers" {
    component PaperModel [PaperModel]
    component PaperService [PaperService]
    component PaperController [PaperController]
    component PaperRepository [PaperRepository]
}

package "reviews" {
    component ReviewModel [ReviewModel]
    component ReviewService [ReviewService]
    component ReviewController [ReviewController]
    component ReviewRepository [ReviewRepository]
}

package "selections" {
    component SelectionService [SelectionService]
    component DecisionModel [DecisionModel]
    component DecisionRepository [DecisionRepository]
}

package "notifications" {
    component NotificationService [NotificationService]
    component EmailQueue [EmailQueue]
    component SMTPConnector [SMTPConnector]
}

package "admin" {
    component AdminService [AdminService]
    component AdminController [AdminController]
    component ReportGenerator [ReportGenerator]
}

' Dependencias
PaperService --> core: usa
ReviewService --> core: usa
SelectionService --> core: usa
NotificationService --> core: usa

PaperService --> auth: consulta
ReviewService --> auth: consulta
SelectionService --> auth: consulta

PaperController --> PaperService: delega
ReviewController --> ReviewService: delega
AdminController --> AdminService: delega

PaperRepository --> PaperModel: maneja
ReviewRepository --> ReviewModel: maneja
DecisionRepository --> DecisionModel: maneja

AdminService --> papers: consulta
AdminService --> reviews: consulta
AdminService --> selections: consulta

SelectionService --> reviews: consulta
SelectionService --> notifications: dispara

@enduml


'=== DIAGRAMA 22: PANTALLA/PÁGINA - DASHBOARD AUTOR ===
@startuml UI_AuthorDashboard
title Vista: Dashboard del Autor

frame "Browser Window" {
    rectangle Header [
        ╔════════════════════════════════════╗
        ║ Sistema de Conferencias            ║
        ║ Usuario: Juan Pérez (Autor)        ║
        ║ [Logout]                           ║
        ╚════════════════════════════════════╝
    ]
    
    rectangle Navigation [
        ┌────────────────────────────────────┐
        │ [Mis Papers] [Estadísticas]        │
        │ [Enviar Nuevo Paper] [Perfil]      │
        └────────────────────────────────────┘
    ]
    
    rectangle Content [
        ┌────────────────────────────────────┐
        │ MIS PAPERS (2)                     │
        ├────────────────────────────────────┤
        │ Paper 1: "ML en Educación"         │
        │ Status: ✓ ACEPTADO (con cambios)   │
        │ Decisión: 7.2/10 promedio          │
        │ [Ver Evaluaciones] [Descargar]     │
        │                                    │
        │ Paper 2: "Análisis de Datos"       │
        │ Status: ⏳ EN REVISIÓN              │
        │ Revisores: 3/3 evaluando           │
        │ [Ver Avance]                       │
        └────────────────────────────────────┘
        
        ┌────────────────────────────────────┐
        │ ENVIAR NUEVO PAPER                 │
        │ [Seleccionar Archivo...]           │
        │ [Completar Metadatos...]           │
        │ [Enviar]                           │
        └────────────────────────────────────┘
    ]
    
    rectangle Footer [
        ┌────────────────────────────────────┐
        │ © 2026 Sistema de Conferencias     │
        └────────────────────────────────────┘
    ]
}

@enduml


'=== DIAGRAMA 23: TRANSICIONES DE ESTADO (STATE MACHINE) ===
@startuml StateMachine_Review
title Máquina de Estados: Ciclo de Review

[*] --> CREATED: createReview()

CREATED --> DRAFT: reviewerStarts()

DRAFT --> DRAFT: updateReview()

DRAFT --> SUBMITTED: submitReview()

SUBMITTED --> SUBMITTED: updateIfNeeded()

SUBMITTED --> COMPLETED: reviewConfirmed()

COMPLETED --> GRADED: adminGrades()

GRADED --> [*]: reviewArchived()

DRAFT -.-> WITHDRAWN: withdrawReview()
WITHDRAWN --> [*]: archived()

@enduml


'=== DIAGRAMA 24: CONFIGURACIÓN DE DISTRIBUCIÓN ===
@startuml Activity_DistributionRules
title Reglas y Lógica: Distribución a Revisores

start

:Admin inicia distribución;

:Para cada paper sin revisor:;

:Obtener especialidad requerida;

:Buscar revisores disponibles
(no saturados);

:Filtro 1: ¿Mismo campo?;
if (¿Coincide especialidad?) then (No)
    :Skip revisor;
else (Sí)
endif

:Filtro 2: ¿No es autor?;
if (¿Conflicto de interés?) then (Sí)
    :Skip revisor;
else (No)
endif

:Filtro 3: ¿Menos de 5 papers?;
if (¿Sobrecargado?) then (Sí)
    :Skip revisor;
else (No)
endif

:Filtro 4: ¿Revisó antes?;
if (¿Expertise comprobada?) then (Sí)
    :+5 puntos;
else (No)
endif

:Filtro 5: ¿Respuesta rápida?;
if (¿Track record bueno?) then (Sí)
    :+3 puntos;
else (No)
endif

:Ordenar candidatos por score;

:Selectionar top 3;

:Crear asignaciones;

:Generar notificaciones;

:Queue emails;

stop

@enduml


'=== DIAGRAMA 25: DIAGRAMA DE SECUENCIA - API CALL COMPLETO ===
@startuml Sequence_APICall
title Secuencia Detallada: Llamada API Completa

actor Client
participant Nginx
participant APIGateway
participant AuthMiddleware
participant PaperController
participant PaperService
participant PaperRepository
participant PostgreSQL as DB

Client -> Nginx: GET /api/papers/123\n(con JWT token)
activate Nginx

Nginx -> APIGateway: Forward request
activate APIGateway

APIGateway -> AuthMiddleware: Valida JWT
activate AuthMiddleware
AuthMiddleware -> AuthMiddleware: Decodifica token\nVerifica firma
AuthMiddleware --> APIGateway: ✓ Válido\n{user_id: 5, role: 'AUTHOR'}
deactivate AuthMiddleware

APIGateway -> PaperController: Router -> getPaper()
activate PaperController

PaperController -> PaperController: Extrae paper_id = 123
PaperController -> PaperService: get_paper_by_id(123)
activate PaperService

PaperService -> PaperRepository: find_by_id(123)
activate PaperRepository

PaperRepository -> DB: SELECT * FROM papers\nWHERE id = 123
activate DB
DB --> PaperRepository: Paper record
deactivate DB

PaperRepository --> PaperService: Paper object
deactivate PaperRepository

PaperService -> PaperService: Verificar autorización:\n¿Usuario es autor\no admin?

PaperService --> PaperController: Paper + metadata
deactivate PaperService

PaperController -> PaperController: Serializar\nresponse JSON

PaperController --> APIGateway: 200 OK\n{id, title, status...}
deactivate PaperController

APIGateway -> APIGateway: Log request\nADD CORS headers

APIGateway --> Nginx: Response
deactivate APIGateway

Nginx -> Nginx: Comprime (gzip)
Nginx --> Client: HTTP 200\nJSON response
deactivate Nginx

Client -> Client: Parse JSON\nActualizar UI

@enduml
